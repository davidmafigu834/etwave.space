import{r as d,j as e}from"./ui-XtzbmeJx.js";import{u as W,m as $,n as ee,C as m,d as x,e as p,ag as se,f as y,g as h,ak as M,B as C,U as I,S as z,i as b}from"./app--U2u_Nco.js";import{A as u,a as j}from"./alert-QWE4c3kv.js";import{P as ae}from"./progress-TOvGrob6.js";import{C as t}from"./circle-check-big-DSNGn9d6.js";import{C as g}from"./circle-x-DvH4-sm2.js";import{D as _}from"./download-qOMTGgoX.js";import{R as k}from"./refresh-cw-fGgpmSVQ.js";import{C as re}from"./clock-xep4wtUq.js";import"./vendor-CxtKjBZA.js";import"./utils-CCVAIzGD.js";function fe({uploadedFile:f,healthStatus:c,availableBackups:U}){const{t:le}=W(),[D,S]=d.useState(!1),[N,A]=d.useState(!1),[H,R]=d.useState(!1),[F,a]=d.useState(0),[i,r]=d.useState("idle"),[K,n]=d.useState(""),P=d.useRef(null),L=s=>{confirm("Are you sure you want to rollback to this backup? This action cannot be undone.")&&(R(!0),r("applying"),n("Rolling back to previous version..."),a(0),B(route("upgrade.rollback"),{data:{backup_id:s},onSuccess:()=>{R(!1),r("completed"),a(100),n("Rollback completed successfully!"),setTimeout(()=>z.reload(),2e3)},onError:()=>{R(!1),r("failed"),a(0),n("Rollback failed")}}))},Z=s=>{if(s===0)return"0 Bytes";const l=1024,o=["Bytes","KB","MB","GB"],w=Math.floor(Math.log(s)/Math.log(l));return parseFloat((s/Math.pow(l,w)).toFixed(2))+" "+o[w]},q=s=>new Date(s*1e3).toLocaleString(),{data:v,setData:T,post:B,processing:te,errors:E,reset:ie}=$({upgrade_file:null}),G=s=>{var o;const l=(o=s.target.files)==null?void 0:o[0];l&&(T("upgrade_file",l),r("idle"))},V=s=>{s.preventDefault(),v.upgrade_file&&(S(!0),r("uploading"),a(0),B(route("upgrade.upload"),{onSuccess:()=>{S(!1),r("uploaded"),a(100)},onError:()=>{S(!1),r("failed"),a(0)},onProgress:l=>{a(l)}}))},X=()=>{if(!f)return;A(!0),r("applying"),a(0),n("Creating backup...");const s=[{step:"Creating backup...",duration:2e3},{step:"Extracting files...",duration:3e3},{step:"Applying changes...",duration:4e3},{step:"Running migrations...",duration:2e3},{step:"Clearing caches...",duration:1e3},{step:"Finalizing upgrade...",duration:1e3}];let l=0;s.forEach((o,w)=>{setTimeout(()=>{n(o.step),l+=100/s.length,a(Math.min(l,95))},s.slice(0,w+1).reduce((O,Q)=>O+Q.duration,0))}),B(route("upgrade.apply"),{data:{file_path:f},onSuccess:()=>{A(!1),r("completed"),a(100),n("Upgrade completed successfully!")},onError:()=>{A(!1),r("failed"),a(0),n("Upgrade failed")}})},Y=()=>{r("idle"),a(0),n(""),T("upgrade_file",null),P.current&&(P.current.value=""),z.reload()},J=()=>{switch(i){case"uploading":case"applying":return e.jsxs(b,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:[e.jsx(re,{className:"w-3 h-3 mr-1"}),"In Progress"]});case"uploaded":return e.jsxs(b,{variant:"secondary",className:"bg-green-100 text-green-800",children:[e.jsx(t,{className:"w-3 h-3 mr-1"}),"Ready to Apply"]});case"completed":return e.jsxs(b,{variant:"secondary",className:"bg-green-100 text-green-800",children:[e.jsx(t,{className:"w-3 h-3 mr-1"}),"Completed"]});case"failed":return e.jsxs(b,{variant:"destructive",children:[e.jsx(g,{className:"w-3 h-3 mr-1"}),"Failed"]});default:return e.jsx(b,{variant:"outline",children:"Idle"})}};return e.jsxs(e.Fragment,{children:[e.jsx(ee,{title:"System Upgrade"}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"System Upgrade"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Upload and apply system upgrades to keep your application updated with the latest features and security patches."})]}),e.jsxs(m,{className:"mb-6",children:[e.jsx(x,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5"}),"Upgrade Status"]}),e.jsx(y,{children:"Current upgrade status and progress"})]}),J()]})}),e.jsxs(h,{children:[i!=="idle"&&e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-sm text-gray-600 mb-2",children:[e.jsx("span",{children:K||"Processing..."}),e.jsxs("span",{children:[Math.round(F),"%"]})]}),e.jsx(ae,{value:F,className:"w-full"})]})}),f&&i==="uploaded"&&e.jsxs(u,{className:"mt-4",children:[e.jsx(t,{className:"h-4 w-4"}),e.jsx(j,{children:'Upgrade file uploaded successfully. Click "Apply Upgrade" to proceed.'})]}),i==="completed"&&e.jsxs(u,{className:"mt-4",children:[e.jsx(t,{className:"h-4 w-4"}),e.jsx(j,{children:"Upgrade completed successfully! Your system has been updated."})]}),i==="failed"&&e.jsxs(u,{variant:"destructive",className:"mt-4",children:[e.jsx(g,{className:"h-4 w-4"}),e.jsx(j,{children:"Upgrade failed. Please check the logs and try again."})]})]})]}),c&&e.jsxs(m,{className:"mb-6",children:[e.jsxs(x,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(t,{className:"w-5 h-5"}),"System Health Status"]}),e.jsx(y,{children:"Check if your system is ready for upgrade"})]}),e.jsxs(h,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[c.database?e.jsx(t,{className:"w-4 h-4 text-green-500"}):e.jsx(g,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm",children:"Database"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c.storage?e.jsx(t,{className:"w-4 h-4 text-green-500"}):e.jsx(g,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm",children:"Storage"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c.cache?e.jsx(t,{className:"w-4 h-4 text-green-500"}):e.jsx(g,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm",children:"Cache"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c.permissions?e.jsx(t,{className:"w-4 h-4 text-green-500"}):e.jsx(g,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:"text-sm",children:"Permissions"})]})]}),(!c.database||!c.storage)&&e.jsxs(u,{variant:"destructive",className:"mt-4",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx(j,{children:"System health check failed. Please resolve the issues before attempting an upgrade."})]})]})]}),U&&U.length>0&&e.jsxs(m,{className:"mb-6",children:[e.jsxs(x,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5"}),"Available Backups"]}),e.jsx(y,{children:"Previous system backups for rollback if needed"})]}),e.jsx(h,{children:e.jsx("div",{className:"space-y-3",children:U.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.id}),e.jsxs("div",{className:"text-sm text-gray-500",children:[q(s.created_at)," â€¢ ",Z(s.size)]})]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>L(s.id),disabled:N||H,children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"Rollback"]})]},s.id))})})]}),e.jsxs(m,{className:"mb-6",children:[e.jsxs(x,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"Upload Upgrade File"]}),e.jsx(y,{children:"Upload a ZIP file containing the upgrade files. Make sure it's a valid upgrade package."})]}),e.jsx(h,{children:e.jsx("form",{onSubmit:V,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("input",{ref:P,type:"file",accept:".zip",onChange:G,className:"hidden",id:"upgrade-file"}),e.jsx("label",{htmlFor:"upgrade-file",className:"flex items-center justify-center w-full h-32 px-4 transition bg-gray-50 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer hover:border-gray-400",children:e.jsxs("div",{className:"text-center",children:[e.jsx(I,{className:"w-8 h-8 mx-auto mb-2 text-gray-400"}),e.jsx("p",{className:"text-sm text-gray-500",children:v.upgrade_file?v.upgrade_file.name:"Click to select upgrade ZIP file"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Maximum file size: 100MB"})]})})]}),E.upgrade_file&&e.jsxs(u,{variant:"destructive",children:[e.jsx(M,{className:"h-4 w-4"}),e.jsx(j,{children:E.upgrade_file})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(C,{type:"submit",disabled:!v.upgrade_file||D||N,className:"flex-1",children:D?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Upload File"]})}),(f||i==="completed"||i==="failed")&&e.jsxs(C,{type:"button",variant:"outline",onClick:Y,disabled:N,children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"Reset"]})]})]})})})]}),f&&i==="uploaded"&&e.jsxs(m,{className:"mb-6",children:[e.jsxs(x,{children:[e.jsxs(p,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5"}),"Apply Upgrade"]}),e.jsx(y,{children:"Apply the uploaded upgrade to your system. This process will:"})]}),e.jsx(h,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("ul",{className:"list-disc list-inside text-sm text-gray-600 space-y-1",children:[e.jsx("li",{children:"Create a backup of essential files"}),e.jsx("li",{children:"Extract and apply the upgrade files"}),e.jsx("li",{children:"Run database migrations if needed"}),e.jsx("li",{children:"Clear system caches"}),e.jsx("li",{children:"Verify the upgrade was successful"})]}),e.jsxs(u,{children:[e.jsx(M,{className:"h-4 w-4"}),e.jsxs(j,{children:[e.jsx("strong",{children:"Important:"})," This action cannot be undone. Make sure you have a recent backup."]})]}),e.jsx(C,{onClick:X,disabled:N,className:"w-full",size:"lg",children:N?e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"w-4 h-4 mr-2 animate-spin"}),"Applying Upgrade..."]}):e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Apply Upgrade"]})})]})})]}),e.jsxs(m,{children:[e.jsx(x,{children:e.jsx(p,{children:"Important Information"})}),e.jsxs(h,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Before Upgrading:"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-gray-600 space-y-1",children:[e.jsx("li",{children:"Create a full backup of your database and files"}),e.jsx("li",{children:"Test the upgrade on a staging environment first"}),e.jsx("li",{children:"Ensure you have sufficient disk space"}),e.jsx("li",{children:"Check that all required PHP extensions are installed"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"During Upgrade:"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-gray-600 space-y-1",children:[e.jsx("li",{children:"Do not interrupt the upgrade process"}),e.jsx("li",{children:"Keep the page open until completion"}),e.jsx("li",{children:"Monitor the progress and status messages"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"After Upgrade:"}),e.jsxs("ul",{className:"list-disc list-inside text-sm text-gray-600 space-y-1",children:[e.jsx("li",{children:"Clear browser cache and cookies"}),e.jsx("li",{children:"Test all major functionality"}),e.jsx("li",{children:"Check that user data is intact"}),e.jsx("li",{children:"Monitor system logs for any errors"})]})]})]})]})]})})]})}export{fe as default};
